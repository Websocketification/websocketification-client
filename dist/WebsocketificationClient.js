!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WebsocketificationClient=t():e.WebsocketificationClient=t()}(window,function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return i(e,[{key:"json",value:function(){return this.body}},{key:"isSuccess",value:function(){return this.status>=200&&this.status<300||304===this.status}},{key:"isValid",value:function(){return this.id&&this.status}}]),e}();o.NewInstance=function(e){try{var t=JSON.parse(e);return Object.setPrototypeOf(t,o.prototype),t}catch(e){}},e.exports=o},function(e,t,n){"use strict";var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var o=n(0),s=function(){function e(t){var n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=i.enableLogging,s=void 0===o||o,r=i.heartbeatInterval,a=void 0===r?5e4:r,c=i.retryWaitingTimeStart,u=void 0===c?0:c,l=i.retryWaitingTimeStep,d=void 0===l?230:l,m=i.autoDisconnectAfter,h=void 0===m?21e5:m;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),["connect","close","onResponse","fetch","setOnBroadcastListener","setOnUnhandledResponseListener","setOnClosedListener","setOnErrorListener"].map(function(e){return n[e]=n[e].bind(n)}),this.fetch=this.fetch.bind(this),this.mIsExpectedToReconnect=!1,this.mIsNicelyClosed=!0,this.mAddress=t,this.mTempListeners=[],this.mGlobalListeners=[],this.mUnhandledListener=void 0,this.mEnableLogging=s,this.mEnableLogging&&(this.mOnError=function(e){return console.error("WebSocket onerror callback triggered: ws.onerror(event)->",e)},this.mOnClose=null),this.mHeartbeatInterval=a,this.mHeartbeatTimeoutHandler=null,this.mRetryWaitingTimeStart=u,this.mRetryWaitingTimeStep=d,this.mRetryWaitingTime=this.mRetryWaitingTimeStart,this.mAutoDisconnectAfter=h,this.mAutoDisconnectionTimeoutHandler=null,this.mRequestWaitingTimeStart=100,this.mRequestWaitingTimeStep=20}return i(e,[{key:"log",value:function(){var e;this.mEnableLogging&&(e=console).log.apply(e,arguments)}},{key:"connect",value:function(){var e=this;return new Promise(function(t,n){try{e.mWS=new WebSocket(e.mAddress)}catch(e){return void n(e,"Invalid address: "+address)}var i=e.mWS;e.log("Connecting to "+i.url+"."),i.onmessage=function(t){if(t.data.startsWith("{")){var n=o.NewInstance(t.data);n?n.isValid()?e.onResponse(n):e.log("Invalid response(fields of id and status are required):",n):e.log("Unexpected response data:",t.data)}else e.handleNoneRequestMessage(t)},i.onopen=function(n){e.log("Connected to "+i.url+"."),e.setupPingLoop(),e.resetDisconnectionTimeout(),e.mRetryWaitingTime=e.mRetryWaitingTimeStart,t(n)},i.onerror=function(t){e.mOnError&&e.mOnError(t),n(t)},i.onclose=function(t){e.onDisconnected(t),e.mOnClose&&e.mOnClose(t),n(t)}})}},{key:"setupPingLoop",value:function(){var e=this;this.mHeartbeatInterval<=0||(this.mHeartbeatTimeoutHandler&&clearTimeout(this.mHeartbeatTimeoutHandler),this.mHeartbeatTimeoutHandler=setTimeout(function(){e.mWS.readyState===WebSocket.OPEN&&(e.mWS.send("$PING"),e.setupPingLoop())},this.mHeartbeatInterval))}},{key:"handleNoneRequestMessage",value:function(e){if(e.data.startsWith("$"))switch(e.data){case"$PING":this.mWS.send("$PONG")}}},{key:"onDisconnected",value:function(e){var t=this;return this.mIsExpectedToReconnect?(this.mIsExpectedToReconnect=!1,this.log("WebSocket disconnected manually by client and a reconnection is scheduled since this.reconnect() is called!"),void this.connect()):e.wasClean?(this.mIsNicelyClosed=!0,void this.log("WebSocket disconnected nicely, by client or server, and auto reconnection will be triggered when any message is needed to be sent.")):(this.mIsNicelyClosed=!1,void(this.mRetryWaitingTime+this.mRetryWaitingTimeStep<=0?this.log("WebSocket disconnected abnormally and no auto reconnection is scheduled due to configuration."):(this.log("WebSocket disconnected abnormally and auto reconnection is scheduled after "+this.mRetryWaitingTime+" milliseconds."),setTimeout(function(){t.connect(),t.mRetryWaitingTime+=t.mRetryWaitingTimeStep},this.mRetryWaitingTime))))}},{key:"resetDisconnectionTimeout",value:function(){var e=this;this.mAutoDisconnectAfter<=0||(this.mAutoDisconnectionTimeoutHandler&&clearTimeout(this.mAutoDisconnectionTimeoutHandler),this.mAutoDisconnectionTimeoutHandler=setTimeout(function(){e.mWS.readyState===WebSocket.OPEN&&e.mWS.close(1e3)},this.mAutoDisconnectAfter))}},{key:"close",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,t=arguments[1];this.mWS.close(e,t)}},{key:"reconnect",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this.mIsExpectedToReconnect=!0,this.close(e)}},{key:"onResponse",value:function(e){var t=this.mTempListeners[e.id];if(t)return delete this.mTempListeners[e.id],void(e.isSuccess()?t.resolve(e):t.reject(e));(t=this.mGlobalListeners[e.id])?e.isSuccess()?t(null,e):t(e):this.mUnhandledListener&&this.mUnhandledListener(e)}},{key:"fetch",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.resetDisconnectionTimeout(),n.path=e,n.id="http$"+Math.random()+"@"+ +new Date,n.method||(n.method="GET"),new Promise(function(e,i){t.sendRequest(e,i,n,t.mRequestWaitingTimeStart)})}},{key:"sendRequest",value:function(e,t,n,i){var o=this;if(this.mWS.readyState===WebSocket.CONNECTING)setTimeout(function(){o.sendRequest(e,t,n,i)},i),i+=this.mRequestWaitingTimeStep;else if(this.mWS.readyState===WebSocket.OPEN)this.mWS.send(JSON.stringify(n)),this.mTempListeners[n.id]={resolve:e,reject:t};else if(this.mWS.readyState===WebSocket.CLOSING||this.mWS.readyState===WebSocket.CLOSED){if(!this.mIsNicelyClosed)return void t(new Error("WebSocket is closed abnormally and is trying to reconnect:"+this.mWS.readyState));this.connect().then(function(){o.mWS.readyState!==WebSocket.OPEN&&t(new Error("WebSocket should be open: "+WebSocket.readyState)),o.mWS.send(JSON.stringify(n)),o.mTempListeners[n.id]={resolve:e,reject:t}}).catch(function(e){t(e)})}}},{key:"setOnBroadcastListener",value:function(e,t){this.mGlobalListeners[e]=t}},{key:"setOnUnhandledResponseListener",value:function(e){this.mUnhandledListener=e}},{key:"setOnClosedListener",value:function(e){this.mOnClose=e}},{key:"setOnErrorListener",value:function(e){this.mOnError=e}}]),e}();e.exports=s},function(e,t,n){"use strict";e.exports=n(1)}])});
//# sourceMappingURL=WebsocketificationClient.js.map